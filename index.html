<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ø¢Ø¨</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="style.css?v=1.1">

  <style>
    body {
      touch-action: none;
    }
  </style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>
  <script src="data.js" defer></script>
</head>

<body>

  <header class="site-header">
    <div class="header-content">
      <i class="fas fa-faucet-drip"></i>
      <h1>ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ù…Ø³ØªÙ‚Ø± Ø¯Ø± Ø³Ø·Ø­ Ø´Ù‡Ø± Ø¨Ø§Ù†Ù‡</h1>
    </div>
  </header>

  <div id="map"></div>
  <div class="map-toggle-wrapper top-right">
    <span class="toggle-label">ØªØºÛŒÛŒØ± Ù†Ù‚Ø´Ù‡</span>
    <label class="switch">
      <input type="checkbox" id="layerCheckbox">
      <span class="slider round"></span>
    </label>
  </div>

  <div id="locate-btn" class="custom-control-btn bottom-center" onclick="locateUser()">
    <i class="fas fa-crosshairs"></i>
  </div>


  <a href="https://t.me/Carwan" target="_blank" class="support-btn top-left">
    <i class="fab fa-telegram-plane"></i>
  </a>
  <!-- legend  -->
  <div id="legend">
    <div class="legend-item">
      <div class="water-icon-5k"> <i class="fas fa-glass-water"></i>
      </div>
      <span>Ûµ Ù‡Ø²Ø§Ø± Ù„ÛŒØªØ±</span>
    </div>

    <div class="legend-item">
      <div class="water-icon"> <i class="fas fa-glass-water"></i></div>
      <span>Û±Û° Ù‡Ø²Ø§Ø± Ù„ÛŒØªØ±</span>
    </div>
  </div>




  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // === Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ù†Ú©Ø±Ù‡Ø§ ===

      if (typeof waterPoints === 'undefined') {
        console.error("ÙØ§ÛŒÙ„ data.js Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");
        return;
      }

      // === 1. ØªØ¹Ø±ÛŒÙ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ ===
      const icon10k = L.divIcon({ className: 'icon-10k', html: "<div class='water-icon'><i class='fas fa-glass-water'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });
      const icon5k = L.divIcon({ className: 'icon-5k', html: "<div class='water-icon-5k'><i class='fas fa-glass-water'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });
      const iconSchool = L.divIcon({ className: 'icon-school', html: "<div class='school-icon'><i class='fas fa-school'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });

      // === 2. Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ (CartoDB Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ùˆ OSM) ===
      const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© CartoDB',
        maxZoom: 19
      });

      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 19
      });

      // Ø´Ø±ÙˆØ¹ Ù†Ù‚Ø´Ù‡ Ø¨Ø§ Carto
      const map = L.map('map', {
        zoomControl: false,
        layers: [cartoLayer]
      }).setView([35.997, 45.887], 14);

      L.control.zoom({ position: 'bottomleft' }).addTo(map);

      // === 3. Ù„Ø§Ø¬ÛŒÚ© Ø³ÙˆÛŒÛŒÚ† Ù†Ù‚Ø´Ù‡ ===
      const checkbox = document.getElementById('layerCheckbox');
      checkbox.addEventListener('change', function () {
        if (this.checked) {
          map.removeLayer(cartoLayer);
          map.addLayer(osmLayer);
        } else {
          map.removeLayer(osmLayer);
          map.addLayer(cartoLayer);
        }
      });

      // === 4. Ø³ÛŒØ³ØªÙ… Ù…Ø§Ø±Ú©Ø± Ùˆ Ú©Ù„Ø§Ø³ØªØ± ===

      let markersLayer; // Ù…ØªØºÛŒØ±ÛŒ Ú©Ù‡ ÛŒØ§ Group Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø³Øª ÛŒØ§ Cluster Group

      // ** Ø´Ø±Ø· Ù…Ù‡Ù…: ÙÙ‚Ø· Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ ØªØ§Ù†Ú©Ø±Ù‡Ø§ Ø¨ÛŒØ´ØªØ± Ø§Ø² 45 Ø¨Ø§Ø´Ø¯ØŒ Ú©Ù„Ø§Ø³ØªØ± ÙØ¹Ø§Ù„ Ø´ÙˆØ¯ **
      if (waterPoints.length > 30) {

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„Ø§Ø³ØªØ± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒÚ©ÙˆÙ†Ø´ Ø´Ø¨ÛŒÙ‡ ØªØ§Ù†Ú©Ø± 10k Ø¨Ø§Ø´Ø¯
        markersLayer = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 18, // Ø¯Ø± Ø²ÙˆÙ… Ø®ÛŒÙ„ÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø² Ø´ÙˆÙ†Ø¯

          // ØªØ§Ø¨Ø¹ Ø³Ø§Ø®Øª Ø¢ÛŒÚ©ÙˆÙ† Ú©Ù„Ø§Ø³ØªØ± Ø³ÙØ§Ø±Ø´ÛŒ
          iconCreateFunction: function (cluster) {
            const count = cluster.getChildCount();
            // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² Ù‡Ù…Ø§Ù† Ú©Ù„Ø§Ø³ water-icon Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… ØªØ§ Ø´Ø¨ÛŒÙ‡ 10k Ø¨Ø§Ø´Ø¯
            // Ø¨Ù‡ Ø¹Ù„Ø§ÙˆÙ‡ ÛŒÚ© Ø¹Ø¯Ø¯ Ú©ÙˆÚ†Ú© (cluster-badge) Ú©Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯
            return L.divIcon({
              html: `
                <div class='cluster-wrapper'>
                   <div class='water-icon'><i class='fas fa-glass-water'></i></div>
                   <span class='cluster-badge'>${count}</span>
                </div>
              `,
              className: 'marker-cluster-custom', // Ú©Ù„Ø§Ø³ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            });
          }
        });

      } else {
        // Ø§Ú¯Ø± Ú©Ù…ØªØ± Ø§Ø² 45 Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù„Ø§ÛŒÙ‡ Ú¯Ø±ÙˆÙ¾ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (Ø¨Ø¯ÙˆÙ† Ú©Ù„Ø§Ø³ØªØ±)
        markersLayer = L.layerGroup();
      }

      // Ø­Ù„Ù‚Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø§Ø±Ú©Ø±Ù‡Ø§
      waterPoints.forEach(point => {
        let iconToUse = icon10k;
        if (point.type === "5k") iconToUse = icon5k;
        if (point.type === "school") iconToUse = iconSchool;

        const marker = L.marker([point.lat, point.lng], { icon: iconToUse });

        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${point.lat},${point.lng}`;

        const popupContent = `
            <div class="popup-content">
              <h3>${point.name}</h3>
              <p>Ú©Ø¯ Ù†Ù‚Ø·Ù‡: ${point.id}</p>
              <a href="${googleMapsUrl}" target="_blank" class="navigate-btn">
                <i class="fas fa-location-arrow"></i> Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
              </a>
              <button class="share-btn" onclick="window.shareLocation(${point.lat}, ${point.lng}, '${point.name}')">
                <i class="fas fa-share-nodes"></i> Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
              </button>
            </div>
        `;
        marker.bindPopup(popupContent, { className: 'custom-popup' });

        // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ø±Ú©Ø± Ø¨Ù‡ Ù„Ø§ÛŒÙ‡ (Ú†Ù‡ Ú©Ù„Ø§Ø³ØªØ± Ø¨Ø§Ø´Ø¯ Ú†Ù‡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ)
        markersLayer.addLayer(marker);
      });

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ù†Ù‚Ø´Ù‡
      map.addLayer(markersLayer);


      // === 5. ØªØ§Ø¨Ø¹ Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ (Ú¯Ù„ÙˆØ¨Ø§Ù„) ===
      window.shareLocation = function (lat, lng, name) {
        const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
        const shareData = {
          title: 'Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØ§Ù†Ú©Ø± Ø¢Ø¨',
          text: `ğŸ“ ${name}\n`,
          url: mapLink
        };
        if (navigator.share) {
          navigator.share(shareData).catch(console.error);
        } else {
          navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`).then(() => alert('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!'));
        }
      };

      // === 6. Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± (Locate Me) ===
      let userMarker = null;

      // === 6. Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ù†Ø³Ø®Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ) ===
      window.locateUser = function () {
        if (!navigator.geolocation) {
          alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ø³Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
          return;
        }

        const btnIcon = document.querySelector('#locate-btn i');
        // Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯
        btnIcon.classList.remove('fa-crosshairs');
        btnIcon.classList.add('fa-spinner', 'fa-spin');

        // ØªØ§Ø¨Ø¹ Ù…ÙˆÙÙ‚ÛŒØª (Ù…Ø´ØªØ±Ú©)
        function success(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          // Ø²ÙˆÙ… Ø±ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±
          map.setView([lat, lng], 16);

          if (userMarker) map.removeLayer(userMarker);

          userMarker = L.circleMarker([lat, lng], {
            radius: 10,
            fillColor: "#ff5722",
            color: "#fff",
            weight: 3,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);

          userMarker.bindPopup("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§").openPopup();

          // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢ÛŒÚ©ÙˆÙ†
          btnIcon.classList.remove('fa-spinner', 'fa-spin');
          btnIcon.classList.add('fa-crosshairs');
        }

        // ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
        function handleError(err, isHighAccuracy) {
          // Ø§Ú¯Ø± ØªÙ„Ø§Ø´ Ø§ÙˆÙ„ (Ø¯Ù‚ÛŒÙ‚) Ø¨ÙˆØ¯ Ùˆ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø´Ø¯ØŒ Ø­Ø§Ù„Ø§ ØªÙ„Ø§Ø´ Ø¯ÙˆÙ… (ØªÙ‚Ø±ÛŒØ¨ÛŒ) Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
          if (isHighAccuracy && (err.code === 3 || err.code === 2)) {
            console.log("GPS failed, trying low accuracy...");
            navigator.geolocation.getCurrentPosition(
              success,
              (finalErr) => handleError(finalErr, false), // Ø§Ú¯Ø± Ø¨Ø§Ø² Ù‡Ù… Ø®Ø·Ø§ Ø¯Ø§Ø¯
              {
                enableHighAccuracy: false, // Ø§ÛŒÙ† Ø¨Ø§Ø± Ø¯Ù‚Øª Ù¾Ø§ÛŒÛŒÙ† (Ø³Ø±ÛŒØ¹â€ŒØªØ±)
                timeout: 10000,
                maximumAge: 0
              }
            );
            return;
          }

          // Ø§Ú¯Ø± ØªÙ„Ø§Ø´ Ø¯ÙˆÙ… Ù‡Ù… Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ ÛŒØ§ Ø®Ø·Ø§ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ø¬ÙˆØ² (Permission) Ø¨ÙˆØ¯:
          btnIcon.classList.remove('fa-spinner', 'fa-spin');
          btnIcon.classList.add('fa-crosshairs');

          if (err.code === 1) {
            alert("Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ (GPS) Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
          } else if (err.code === 2) {
            alert("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ GPS Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯.");
          } else if (err.code === 3) {
            alert("Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ GPS Ø¶Ø¹ÛŒÙ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.");
          } else {
            alert("Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡.");
          }
        }

        // ØªÙ„Ø§Ø´ Ø§ÙˆÙ„: Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø§Ù„Ø§ (High Accuracy)
        navigator.geolocation.getCurrentPosition(
          success,
          (err) => handleError(err, true),
          {
            enableHighAccuracy: true,
            timeout: 15000, // 15 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ GPS ØµØ¨Ø± Ú©Ù†
            maximumAge: 0
          }
        );
      };

    });
  </script>
</body>

</html>