<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Water Tank - ุชุงูฺฉุฑูุง ุขุจ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link rel="stylesheet" href="style.css?v=1.1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      touch-action: none;
    }
  </style>
</head>

<body>

  <header class="site-header">
    <div class="header-content">
      <i class="fas fa-faucet-drip"></i>
      <h1>ุชุงูฺฉุฑูุง ุงุณุชูุฑุงุฑุงูุชู ุฏุฑ ุณุทุญ ุดูุฑ ุจุงูู</h1>
    </div>
  </header>

  <div id="map"></div>
  <div class="map-toggle-wrapper top-right">
    <span class="toggle-label">ุชุบุฑ ููุดู</span>
    <label class="switch">
      <input type="checkbox" id="layerCheckbox">
      <span class="slider round"></span>
    </label>
  </div>

  <div id="locate-btn" class="custom-control-btn bottom-center" onclick="locateUser()">
    <i class="fas fa-crosshairs"></i>
  </div>

  <!-- legend  -->
  <div id="legend">
    <div class="legend-item">
      <div class="water-icon-5k"> <i class="fas fa-glass-water"></i>
      </div>
      <span>ต ูุฒุงุฑ ูุชุฑ</span>
    </div>

    <div class="legend-item">
      <div class="water-icon"> <i class="fas fa-glass-water"></i></div>
      <span>ฑฐ ูุฒุงุฑ ูุชุฑ</span>
    </div>
  </div>

  <!-- legend finish -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>




  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // === ุฏุงุฏูโูุง ุชุงูฺฉุฑูุง ===

      const waterPoints = [
        { id: 1, name: "ุขุชุด ูุดุงู ุขุฒุงุฏฺฏุงู", lat: 36.002273, lng: 45.879323, type: "10k" },
        { id: 2, name: "ุจูุงุฏ ูุณฺฉู", lat: 36.010753, lng: 45.862395, type: "10k" },
        { id: 3, name: "ูพููพ ุจูุฒู ุณุงุฑ", lat: 36.005017, lng: 45.882438, type: "10k" },
        { id: 4, name: "ุงุฏุงุฑู ุจูุฒุณุช (ฑฐฐ ูุชุฑ ูพุงู ุชุฑ ุงุฒ ุฏุฑุจ ูุฑูุฏ)", lat: 36.000844, lng: 45.888383, type: "10k" },
        { id: 5, name: "ุขุชุด ูุดุงู ุชุฑุฎุงู ุขุจุงุฏ (ุฌูุจ ุฏุฑุจ ูุฑูุฏ)", lat: 35.990426, lng: 45.902377, type: "10k" },
        { id: 6, name: "ูุฏุฑุณู ุดุจู", lat: 35.985774, lng: 45.895147, type: "10k" },
        { id: 7, name: "ูุฑูุงูุฏุงุฑ (ุงูู ฺฉูฺู ุฒูุฏุงู)", lat: 35.985685, lng: 45.887780, type: "" },
        { id: 8, name: "ุงุฏุงุฑู ฺฉุงุฑ (ณฐ ูุชุฑ ูพุงู ุชุฑ ุงุฒ ุฏุฑุจ ูุฑูุฏ ุจู ุทุฑู ุชุงูุงุฑ ฺููพ)", lat: 35.992911, lng: 45.874881, type: "10k" },
        { id: 9, name: "ูุฏุฑุณู ุจู ุฑุฒุงู", lat: 36.000826, lng: 45.852401, type: "10k" },
        { id: 10, name: "ูู ุญุฑูู ุง (ุฌูุจ ุฏุฑุจ ูุฑูุฏ ุณุงุฎุชูุงู)", lat: 35.996163, lng: 45.868960, type: "10k" },
        { id: 11, name: "ุงุฏุงุฑู ูุฎุงุจุฑุงุช (ุฏูุงุฑ ูพุดุช ุงุฏุงุฑู)", lat: 35.993735, lng: 45.887804, type: "" },
        { id: 12, name: "ุงุฏุงุฑู ุขููุฒุด ู ูพุฑูุฑุด (ฺฉูฺู ุฌูุจ ุขููุฒุด ูพุฑูุฑุด ุฑูุจุฑู ุงุฏุงุฑู ุจุฑู)", lat: 35.989847, lng: 45.892974, type: "10k" },
        { id: 13, name: "ูุฏุฑุณู ุงูุงู ุฎูู (ุฌุงุฏู ุณููุงูู)", lat: 35.999492, lng: 45.868697, type: "10k" },
        { id: 14, name: "ูุฏุฑุณู ฺฉุงูู ูุญูุฏ (ฺูุงุฑ ุฑุงู ุซุจุช ุงุญูุงู)", lat: 35.987182, lng: 45.882816, type: "10k" },
        { id: 15, name: "ูุฏุฑุณู ุฏูุงูู (ุถูุน ุดุฑู ูุฏุฑุณู)", lat: 35.979571, lng: 45.914333, type: "10k" },
        { id: 16, name: "ูุฏุฑุณู ฺฉู ูุฑููฺฏุงู (ูุฑูุฏ ุฒูู ฺูู)", lat: 36.001385, lng: 45.895745, type: "10k" },
        { id: 17, name: "ูุฏุฑุณู ุดูุฑฺฉ ููุฑ", lat: 35.984435, lng: 45.904250, type: "10k" },
        { id: 18, name: "ูุฏุฑุณู ุงุญูุฏ ุขุจุงุฏ ุฌูุจ ูุณฺฉู ููุฑูุง", lat: 35.998648, lng: 45.903658, type: "10k" },
        { id: 19, name: "ุชุฑฺู ุณุนุฏูพูุฑ ุชุฑุฎุงู ุขุจุงุฏ", lat: 35.989129, lng: 45.905801, type: "10k" },
        { id: 20, name: "ูุฏุฑุณู ุจู ุชุฑุฎุงู ุขุจุงุฏ ู ูููู", lat: 35.989496, lng: 45.907326, type: "10k" },
        { id: 21, name: "ุจุงุดฺฏุงู ุตูุฑ", lat: 35.989009, lng: 45.898944, type: "10k" },
        { id: 22, name: "ุนุซูุงู ุขุจุงุฏ", lat: 35.979777, lng: 45.905051, type: "10k" },
        { id: 23, name: "ุงุชูุงูุงุช ุงุฏุงุฑู ุขุจ (ตฐ ูุชุฑ ุจุงูุงุชุฑ ุงุฒ ุฏุฑุจ ูุฑูุฏ ุฑูุจุฑู ฺฉูุชู ุงูุฏุงุฏ)", lat: 35.983330, lng: 45.895308, type: "10k" },
        { id: 24, name: "ูุฏุฑุณู ุฏฺฉุชุฑ ุญุณุงุจ", lat: 35.992291, lng: 45.896519, type: "10k" },
        { id: 25, name: "ุญุงุท ุดุฎุต ูุงูุน ุฏุฑ ูุจุด ฺฉูุฑุจูุฏ ฒ ู ุฎุงุจุงู ุงูุงฺฉู", lat: 35.983050, lng: 45.885654, type: "10k" },
        { id: 26, name: "ุฏุฑูุงูฺฏุงู ุชุฎุตุต ุจูุงุฑุณุชุงู ุตูุงุญ ุงูุฏู", lat: 35.987384, lng: 45.885947, type: "10k" },
        { id: 27, name: "ูุฎุงุจุฑุงุช ุณุงุจู", lat: 35.991866, lng: 45.889481, type: "10k" },
        { id: 28, name: "ูพุงุฑฺฉ ูุณฺฉู ููุฑ ูุฏุงู ฺฏุงุฒ", lat: 36.005793, lng: 45.895839, type: "10k" },
        { id: 29, name: "ุณูพุงู ุตุงูุญ ุขุจุงุฏ", lat: 36.004583, lng: 45.876497, type: "10k" },
        { id: 30, name: "ุฎุงูู ุณุงุฒูุงู ููฺฏ ูุฑุฒ ูุงูุน ุฏุฑ ูุฏุงู ุดูุฑุง", lat: 36.006119, lng: 45.871066, type: "10k" },
        { id: 31, name: "ูุฏุฑุณู ุดูุฑฺฉ ุฑูุงู ุจููุงุฑ ฺฉุฑุฏุณุชุงู", lat: 36.004586, lng: 45.861207, type: "10k" },
        { id: 33, name: "ุงุฑุชุด", lat: 35.989487, lng: 45.878260, type: "10k" },
        { id: 34, name: "ูุณุฌุฏ ูุงูุน ุฏุฑ ุดูุฑฺฉ ูุงูู", lat: 35.998442, lng: 45.859277, type: "10k" },
        { id: 35, name: "ุจุงุดฺฏุงู ฺฏูุดูุฑ", lat: 35.997735, lng: 45.872272, type: "10k" },
        { id: 36, name: "ูุฏุฑุณู ูู ุญุฑูู ุง ุณููุงู ุฎุงุทุฑ", lat: 35.997695, lng: 45.876565, type: "10k" },
        { id: 37, name: "ูุณุฌุฏ ูุงูุน ุฏุฑ ุดูุฑฺฉ ุฏุงุฏฺฏุณุชุฑ", lat: 36.006194, lng: 45.868182, type: "10k" },
        { id: 38, name: "ูุฏุฑุณู ููุงุตุงูุญ ุงุญูุฏ ูุญูู ูพุฑูุฑุงุฏ", lat: 35.980659, lng: 45.900380, type: "10k" },
        { id: 39, name: "ุงุฑุดุงุฏ ุงุณูุงู ูุฑูุฑ ุฑูุจุฑู ููฺฉู ููุฑ", lat: 35.994424, lng: 45.889775, type: "10k" },
        { id: 40, name: "ุจููุงุฑ ุจูุงู ุญุจุด", lat: 36.005218, lng: 45.890740, type: "10k" }
      ];

      // === 1. ุชุนุฑู ุขฺฉููโูุง ===
      const icon10k = L.divIcon({ className: 'icon-10k', html: "<div class='water-icon'><i class='fas fa-glass-water'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });
      const icon5k = L.divIcon({ className: 'icon-5k', html: "<div class='water-icon-5k'><i class='fas fa-glass-water'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });
      const iconSchool = L.divIcon({ className: 'icon-school', html: "<div class='school-icon'><i class='fas fa-school'></i></div>", iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -10] });

      // === 2. ูุงูโูุง ููุดู (CartoDB ูพุดโูุฑุถ ู OSM) ===
      const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: 'ยฉ CartoDB',
        maxZoom: 19
      });

      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'ยฉ OpenStreetMap',
        maxZoom: 19
      });

      // ุดุฑูุน ููุดู ุจุง Carto
      const map = L.map('map', {
        zoomControl: false,
        layers: [cartoLayer]
      }).setView([35.997, 45.887], 14);

      L.control.zoom({ position: 'bottomleft' }).addTo(map);

      // === 3. ูุงุฌฺฉ ุณูฺ ููุดู ===
      const checkbox = document.getElementById('layerCheckbox');
      checkbox.addEventListener('change', function () {
        if (this.checked) {
          map.removeLayer(cartoLayer);
          map.addLayer(osmLayer);
        } else {
          map.removeLayer(osmLayer);
          map.addLayer(cartoLayer);
        }
      });

      // === 4. ุณุณุชู ูุงุฑฺฉุฑ ู ฺฉูุงุณุชุฑ ===

      let markersLayer; // ูุชุบุฑ ฺฉู ุง Group ูุนููู ุงุณุช ุง Cluster Group

      // ** ุดุฑุท ููู: ููุท ุงฺฏุฑ ุชุนุฏุงุฏ ุชุงูฺฉุฑูุง ุจุดุชุฑ ุงุฒ 45 ุจุงุดุฏุ ฺฉูุงุณุชุฑ ูุนุงู ุดูุฏ **
      if (waterPoints.length > 30) {

        // ุชูุธูุงุช ฺฉูุงุณุชุฑ ุจุฑุง ุงูฺฉู ุขฺฉููุด ุดุจู ุชุงูฺฉุฑ 10k ุจุงุดุฏ
        markersLayer = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 18, // ุฏุฑ ุฒูู ุฎู ูุฒุฏฺฉ ุฎูุดูโูุง ุจุงุฒ ุดููุฏ

          // ุชุงุจุน ุณุงุฎุช ุขฺฉูู ฺฉูุงุณุชุฑ ุณูุงุฑุด
          iconCreateFunction: function (cluster) {
            const count = cluster.getChildCount();
            // ุงูุฌุง ุงุฒ ููุงู ฺฉูุงุณ water-icon ุงุณุชูุงุฏู ูฺฉูู ุชุง ุดุจู 10k ุจุงุดุฏ
            // ุจู ุนูุงูู ฺฉ ุนุฏุฏ ฺฉูฺฺฉ (cluster-badge) ฺฉู ุชุนุฏุงุฏ ุฑุง ูุดุงู ุฏูุฏ
            return L.divIcon({
              html: `
                <div class='cluster-wrapper'>
                   <div class='water-icon'><i class='fas fa-glass-water'></i></div>
                   <span class='cluster-badge'>${count}</span>
                </div>
              `,
              className: 'marker-cluster-custom', // ฺฉูุงุณ ุฎุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุณุชุงู ูพุดโูุฑุถ
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            });
          }
        });

      } else {
        // ุงฺฏุฑ ฺฉูุชุฑ ุงุฒ 45 ุจูุฏุ ุงุฒ ูุงู ฺฏุฑููพ ูุนููู ุงุณุชูุงุฏู ฺฉู (ุจุฏูู ฺฉูุงุณุชุฑ)
        markersLayer = L.layerGroup();
      }

      // ุญููู ุงุฌุงุฏ ูุงุฑฺฉุฑูุง
      waterPoints.forEach(point => {
        let iconToUse = icon10k;
        if (point.type === "5k") iconToUse = icon5k;
        if (point.type === "school") iconToUse = iconSchool;

        const marker = L.marker([point.lat, point.lng], { icon: iconToUse });

        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${point.lat},${point.lng}`;

        const popupContent = `
            <div class="popup-content">
              <h3>${point.name}</h3>
              <p>ฺฉุฏ ููุทู: ${point.id}</p>
              <a href="${googleMapsUrl}" target="_blank" class="navigate-btn">
                <i class="fas fa-location-arrow"></i> ูุณุฑุงุจ
              </a>
              <button class="share-btn" onclick="window.shareLocation(${point.lat}, ${point.lng}, '${point.name}')">
                <i class="fas fa-share-nodes"></i> ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ
              </button>
            </div>
        `;
        marker.bindPopup(popupContent, { className: 'custom-popup' });

        // ุงูุฒูุฏู ูุงุฑฺฉุฑ ุจู ูุงู (ฺู ฺฉูุงุณุชุฑ ุจุงุดุฏ ฺู ูุนููู)
        markersLayer.addLayer(marker);
      });

      // ุงุถุงูู ฺฉุฑุฏู ูุงู ููุง ุจู ููุดู
      map.addLayer(markersLayer);


      // === 5. ุชุงุจุน ุงุดุชุฑุงฺฉ ฺฏุฐุงุฑ (ฺฏููุจุงู) ===
      window.shareLocation = function (lat, lng, name) {
        const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
        const shareData = {
          title: 'ุงุดุชุฑุงฺฉ ฺฏุฐุงุฑ ูููุนุช ุชุงูฺฉุฑ ุขุจ',
          text: `๐ ${name}\n`,
          url: mapLink
        };
        if (navigator.share) {
          navigator.share(shareData).catch(console.error);
        } else {
          navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`).then(() => alert('ููฺฉ ฺฉูพ ุดุฏ!'));
        }
      };

      // === 6. ูููุนุชโุงุจ ฺฉุงุฑุจุฑ (Locate Me) ===
      let userMarker = null;

      // === 6. ูููุนุชโุงุจ ฺฉุงุฑุจุฑ (ูุณุฎู ูพุดุฑูุชู ู ุฏูู) ===
      window.locateUser = function () {
        if (!navigator.geolocation) {
          alert("ูุฑูุฑฺฏุฑ ุดูุง ูุฏู ุงุณุช ู ูพุดุชุจุงู ููโฺฉูุฏ.");
          return;
        }

        const btnIcon = document.querySelector('#locate-btn i');
        // ุญุงูุช ููุฏูฺฏ (ุขฺฉูู ฺุฑุฎุงู)
        btnIcon.classList.remove('fa-crosshairs');
        btnIcon.classList.add('fa-spinner', 'fa-spin');

        // ุชูุธูุงุช ุฏูู ูููุนุชโุงุจ (ุทุจู ูุงู ุงูู)
        const options = {
          enableHighAccuracy: true, // ุงูููุช ุจุง GPS ุฏูู
          timeout: 15000,           // 15 ุซุงูู ุตุจุฑ ฺฉู
          maximumAge: 10000         // ุงฺฏุฑ ููฺฉุดู 10 ุซุงูู ูพุด ุฑุง ุฏุงุฑุ ููุงู ุฑุง ุจุฏู (ุณุฑุนโุชุฑ)
        };

        function success(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          // ุฒูู ุฑู ฺฉุงุฑุจุฑ
          map.setView([lat, lng], 16);

          // ุญุฐู ูุงุฑฺฉุฑ ูุจู ุงฺฏุฑ ูุฌูุฏ ุฏุงุดุช
          if (userMarker) map.removeLayer(userMarker);

          // ุงุฌุงุฏ ูุงุฑฺฉุฑ ุฌุฏุฏ (ุฏุงุฑูโุง ุดุจู ูุงู ุงูู)
          userMarker = L.circleMarker([lat, lng], {
            radius: 10,
            fillColor: "#ff5722", // ุฑูฺฏ ูุงุฑูุฌ ูพุฑุฑูฺฏ (ูุชูุงุฒ ุงุฒ ุณูุฏ)
            color: "#fff",        // ุญุงุดู ุณูุฏ ุจุฑุง ุฏุฏู ุดุฏู ุจูุชุฑ
            weight: 3,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);

          userMarker.bindPopup("ูููุนุช ุดูุง").openPopup();

          // ุจุงุฒฺฏุดุช ุขฺฉูู ุฏฺฉูู ุจู ุญุงูุช ุนุงุฏ
          btnIcon.classList.remove('fa-spinner', 'fa-spin');
          btnIcon.classList.add('fa-crosshairs');
        }

        function error(err) {
          // ุจุงุฒฺฏุดุช ุขฺฉูู ุฏฺฉูู ุจู ุญุงูุช ุนุงุฏ
          btnIcon.classList.remove('fa-spinner', 'fa-spin');
          btnIcon.classList.add('fa-crosshairs');

          // ูุฏุฑุช ุฏูู ุฎุทุงูุง (ุทุจู ูุงู ุงูู)
          if (err.code === 1) {
            alert("ุดูุง ุงุฌุงุฒู ุฏุณุชุฑุณ ุจู ูููุนุช ูฺฉุงู ุฑุง ุฑุฏ ฺฉุฑุฏุฏ.");
          } else if (err.code === 2) {
            alert("ูููุนุช ูฺฉุงู ุดูุง ูพุฏุง ูุดุฏ (GPS ุฎุงููุด ุงุณุชุ).");
          } else if (err.code === 3) {
            alert("ุฒูุงู ุฏุฑุฎูุงุณุช ุชูุงู ุดุฏ. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.");
          } else {
            alert("ุฎุทุง ูุงุดูุงุฎุชู ุฏุฑ ุฏุฑุงูุช ูููุนุช.");
          }
          console.warn(`ERROR(${err.code}): ${err.message}`);
        }

        navigator.geolocation.getCurrentPosition(success, error, options);
      };

    });
  </script>
</body>

</html>